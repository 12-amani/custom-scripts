# Forest Cut Temporal Detection Script

<a href="#" id='togglescript'>Show</a> script or [download](forestcut_temporaldetection.js){:target="_blank"} it.
<div id='script_view' style="display:none">
{% highlight javascript %}
      {% include_relative forestcut_temporaldetection.js %}
{% endhighlight %}
</div>

## Evaluate and visualize
 - [Sentinel Playground temporal](https://apps.sentinel-hub.com/sentinel-playground-temporal/?source=S2&lat=-18.702797593630123&lng=48.444085121154785&zoom=14&preset=CUSTOM&layers=B04,B03,B02&maxcc=20&gain=1.0&temporal=true&gamma=1.0&time=2015-01-01%7C2018-10-18&atmFilter=ATMCOR&showDates=false&evalscript=Ly8gTWluaW11bSBkaWZmZXJlbmNlIGJldHdlZW4gdGhlIHR3byBtZWFuIE5EVklzCnZhciB0aHJlc29sZCA9IDAuMjU7Ci8vIFRocmVzb2xkIHRvIGRpc21pc3MgY2xvdWRzIHRvIGNhbGN1bGF0ZSB0aGUgbWVhbgp2YXIgYmx1ZVRocmVzb2xkID0gMC4xODsKLy8gTWluaW11bSBtZWFuIE5EVkkgdG8gY29uc2lkZXIgZm9yIG1vbnRoKHMpIG9mIGxhc3QgeWVhcgp2YXIgbWluaW11bk5EVkkgPSAwLjc7Ci8vIHRvIG5vcm1hbGl6ZSBjb2xvcm1hcAp2YXIgc3RyZXRjaE1pbiA9IDA7CnZhciBzdHJldGNoTWF4ID0gMC44OwoKZnVuY3Rpb24gc2V0dXAoZHNzKSB7CiAgICBzZXRJbnB1dENvbXBvbmVudHMoW2Rzcy5CMDIsIGRzcy5CMDMsIGRzcy5CMDQsIGRzcy5CMDUsIGRzcy5CMDgsIGRzcy5CMTJdKTsKICAgIHNldE91dHB1dENvbXBvbmVudENvdW50KDMpOwp9CgpmdW5jdGlvbiBzdHJldGNoKHZhbCwgbWluLCBtYXgpIHsKICAgIHJldHVybiAodmFsIC0gbWluKSAvIChtYXggLSBtaW4pOwp9CgoKZnVuY3Rpb24gTkRWSShzYW1wbGUpIHsKICAgIGxldCBkZW5vbSA9IHNhbXBsZS5CMDggKyBzYW1wbGUuQjA0OwogICAgcmV0dXJuICgoZGVub20gIT0gMCkgPyAoc2FtcGxlLkIwOCAtIHNhbXBsZS5CMDQpIC8gZGVub20gOiAwLjApOwp9CgpmdW5jdGlvbiBORFdJKHNhbXBsZSkgewogICAgbGV0IGRlbm9tID0gc2FtcGxlLkIwMyArIHNhbXBsZS5CMDg7CiAgICByZXR1cm4gKChkZW5vbSAhPSAwKSA%2FIChzYW1wbGUuQjAzIC0gc2FtcGxlLkIwOCkgLyBkZW5vbSA6IC0xKTsKfQoKZnVuY3Rpb24gbWVhbihhcnJheSkgewogICAgaWYgKGFycmF5Lmxlbmd0aCA9PSAwKSB7CiAgICAgICAgcmV0dXJuIDEKICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHN1bSA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBzdW0gKz0gcGFyc2VGbG9hdChhcnJheVtpXSk7IC8vZG9uJ3QgZm9yZ2V0IHRvIGFkZCB0aGUgYmFzZQogICAgICAgIH0KCiAgICAgICAgdmFyIGF2ZyA9IHN1bSAvIGFycmF5Lmxlbmd0aDsKICAgICAgICByZXR1cm4gYXZnCiAgICB9Cn0KCi8vIE1hbmFnZSBvdmVybGFwcGluZyB5ZWFycy4KLy8gSWYgamFudWFyeSBpcyBzZWxlY3RlZCBhbmQgdXNlciBuZWVkIDIgbW9udGhzIHRvIHRha2UKLy8gc2NyaXB0IG5lZWRzIHRvIHRha2UgZGVjZW1iZXIgZnJvbSBsYXN0IHllYXIgYXMgc2Vjb25kIG1vbnRoLgpmdW5jdGlvbiBnZXROZWVkZWREYXRlcyhzY2VuZU1vbnRoLCBzY2VuZVllYXIsIG1vbnRoc1RvVGFrZSkgewogICAgbGV0IG1vbnRoVG9HZXQgPSBbXTsKICAgIGxldCB5ZWFyVG9HZXQgPSBbXTsKCiAgICBmb3IgKGkgPSAwOyBpIDwgbW9udGhzVG9UYWtlOyBpKyspIHsKICAgICAgICBpZiAoc2NlbmVNb250aCAtIGkgPD0gMCkgewogICAgICAgICAgICBtb250aCA9IDEyIC0gKHNjZW5lTW9udGggLSBpKTsKICAgICAgICAgICAgeWVhciA9IHNjZW5lWWVhciAtIDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbW9udGggPSBzY2VuZU1vbnRoIC0gaTsKICAgICAgICAgICAgeWVhciA9IHNjZW5lWWVhcjsKICAgICAgICB9CiAgICAgICAgbW9udGhUb0dldC5wdXNoKG1vbnRoKTsKICAgICAgICB5ZWFyVG9HZXQucHVzaCh5ZWFyKTsKICAgIH0KCiAgICByZXR1cm4gW21vbnRoVG9HZXQsIHllYXJUb0dldF07Cn0KCmZ1bmN0aW9uIGV2YWx1YXRlUGl4ZWwoc2FtcGxlcywgc2NlbmVzKSB7CiAgICBsZXQgaW5pdE1vbnRoID0gc2NlbmVzWzBdLmRhdGUuZ2V0TW9udGgoKTsKICAgIGxldCBpbml0WWVhciA9IHNjZW5lc1swXS5kYXRlLmdldEZ1bGxZZWFyKCk7CgogICAgbGV0IG1vbnRoc0FuZFllYXJzID0gZ2V0TmVlZGVkRGF0ZXMoaW5pdE1vbnRoLCBpbml0WWVhciwgMyk7CgogICAgbGV0IGN1cnJlbnRZZWFyTkRWSSA9IDA7CiAgICBsZXQgY3VycmVudFllYXJDb3VudCA9IDA7CgogICAgbGV0IHByZXZpb3VzWWVhck5EVkkgPSAwOwogICAgbGV0IHByZXZpb3VzWWVhckNvdW50ID0gMDsKICAgIGxldCBsYXN0WWVhck1vbnRoMCA9IFtdOwogICAgbGV0IGxhc3RZZWFyTW9udGgxID0gW107CiAgICBsZXQgbGFzdFllYXJNb250aDIgPSBbXTsKCiAgICBmb3IgKGkgPSAwOyBpIDwgc2FtcGxlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICghKHNhbXBsZXNbaV0uQjA0ID09IDApICYgIShzYW1wbGVzW2ldLkIwMyA9PSAwKSkgewogICAgICAgICAgICBzY2VuZU1vbnRoID0gc2NlbmVzW2ldLmRhdGUuZ2V0TW9udGgoKTsKICAgICAgICAgICAgc2NlbmVZZWFyID0gc2NlbmVzW2ldLmRhdGUuZ2V0RnVsbFllYXIoKTsKICAgICAgICAgICAgaWYgKG1vbnRoc0FuZFllYXJzWzBdLmluY2x1ZGVzKHNjZW5lTW9udGgpKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlc1tpXS5CMDIgPCBibHVlVGhyZXNvbGQpIHsKICAgICAgICAgICAgICAgICAgICBuZHZpID0gTkRWSShzYW1wbGVzW2ldKTsKICAgICAgICAgICAgICAgICAgICBpZiAobW9udGhzQW5kWWVhcnNbMV0uaW5jbHVkZXMoc2NlbmVZZWFyKSkKICAgICAgICAgICAgICAgICAgICAvLyBpZiBjdXJyZW50IHllYXIgKGxhc3QgMTIgbW9udGhzIG1heCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRZZWFyTkRWSSA9IGN1cnJlbnRZZWFyTkRWSSArIG5kdmk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRZZWFyQ291bnQrKzsKCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIGlmIHllYXIgYmVmb3JlCiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobW9udGhzQW5kWWVhcnNbMV0uaW5jbHVkZXMoc2NlbmVZZWFyICsgMSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNZZWFyTkRWSSA9IHByZXZpb3VzWWVhck5EVkkgKyBuZHZpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vbnRoc0FuZFllYXJzWzBdWzBdID09IHNjZW5lTW9udGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RZZWFyTW9udGgwLnB1c2gobmR2aSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobW9udGhzQW5kWWVhcnNbMF1bMV0gPT0gc2NlbmVNb250aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFllYXJNb250aDEucHVzaChuZHZpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtb250aHNBbmRZZWFyc1swXVsyXSA9PSBzY2VuZU1vbnRoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0WWVhck1vbnRoMi5wdXNoKG5kdmkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzWWVhckNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIGNvbXB1dGUgdGhlIG1lYW4KICAgIGxldCBhdmdDdXJyZW50WWVhck5EVkkgPSBjdXJyZW50WWVhck5EVkkgLyBjdXJyZW50WWVhckNvdW50OwogICAgbGV0IGF2Z1ByZXZpb3VzWWVhck5EVkkgPSBwcmV2aW91c1llYXJORFZJIC8gcHJldmlvdXNZZWFyQ291bnQ7CgogICAgLy8gaWYgbmR2aSBkZWNyZWFzZXMgZnJvbSBkZWZpbmVkIHRocmVzb2xkIGluIHRoZSBzYW1lIG1vbnRocyBmcm9tIHByZXZpb3VzIHllYXIKICAgIC8vIGhpZ2hsaWdodHMgaW4gcmVkIHRoZSBwaXhlbAogICAgLy8gY2hlY2sgYWxzbyBpZiBpcyBub3Qgd2F0ZXIKICAgIGxldCBkaWZmZXJlbmNlID0gYXZnUHJldmlvdXNZZWFyTkRWSSAtIGF2Z0N1cnJlbnRZZWFyTkRWSTsKCiAgICBpZiAoKE5EV0koc2FtcGxlc1swXSkgPCAwLjUpICYgKGRpZmZlcmVuY2UgPj0gdGhyZXNvbGQpICYgKGF2Z1ByZXZpb3VzWWVhck5EVkkgPiBtaW5pbXVuTkRWSSkgJiAobWVhbihsYXN0WWVhck1vbnRoMCkgPiBtaW5pbXVuTkRWSSkgJiAobWVhbihsYXN0WWVhck1vbnRoMSkgPiBtaW5pbXVuTkRWSSkgJiAobWVhbihsYXN0WWVhck1vbnRoMikgPiBtaW5pbXVuTkRWSSkpIHsKICAgICAgICAvLyB0aGUgbW9yZSB0aGUgZGlmZmVyZW5jZSBpcyBoaWdoLCB0aGUgbW9yZSBpdCBpcyByZWQKICAgICAgICBjb2xvck1hcCA9IFtzdHJldGNoKCgyLjggKiAoMiAvIDMpICogMTAgKiBkaWZmZXJlbmNlICogc2FtcGxlc1swXS5CMDQgKyAwLjEgKiBzYW1wbGVzWzBdLkIwNSksIHN0cmV0Y2hNaW4sIHN0cmV0Y2hNYXgpLCBzdHJldGNoKCgyLjggKiBzYW1wbGVzWzBdLkIwMyArIDAuMTUgKiBzYW1wbGVzWzBdLkIwOCksIHN0cmV0Y2hNaW4sIHN0cmV0Y2hNYXgpLCBzdHJldGNoKCgyLjggKiBzYW1wbGVzWzBdLkIwMiksIHN0cmV0Y2hNaW4sIHN0cmV0Y2hNYXgpXTsKICAgIH0KICAgIC8vIGVsc2Ugc2hvdyBjdXJyZW50IGltYWdlCiAgICBlbHNlIHsKICAgICAgICBjb2xvck1hcCA9IFtzdHJldGNoKCgyLjggKiBzYW1wbGVzWzBdLkIwNCArIDAuMSAqIHNhbXBsZXNbMF0uQjA1KSwgc3RyZXRjaE1pbiwgc3RyZXRjaE1heCksIHN0cmV0Y2goKDIuOCAqIHNhbXBsZXNbMF0uQjAzICsgMC4xNSAqIHNhbXBsZXNbMF0uQjA4KSwgc3RyZXRjaE1pbiwgc3RyZXRjaE1heCksIHN0cmV0Y2goKDIuOCAqIHNhbXBsZXNbMF0uQjAyKSwgc3RyZXRjaE1pbiwgc3RyZXRjaE1heCldOwogICAgfQogICAgcmV0dXJuIGNvbG9yTWFwOwp9CgpmdW5jdGlvbiBmaWx0ZXJTY2VuZXMoc2NlbmVzLCBpbnB1dE1ldGFkYXRhKSB7CiAgICByZXR1cm4gc2NlbmVzLmZpbHRlcihmdW5jdGlvbihzY2VuZSkgewogICAgICAgIHJldHVybiBzY2VuZS5kYXRlLmdldFRpbWUoKSA%2BPSAoaW5wdXRNZXRhZGF0YS50by5nZXRUaW1lKCkgLSAoMTQgKiAzMSAqIDI0ICogMzYwMCAqIDEwMDApKTsgLy8gMTQgPSAxMSBtb250aHMgKyAzIG1vbnRocwogICAgfSk7Cn0K){:target="_blank"}    
 

## General description of the script

Forests are essential for wildlife, biodiversity and to fight climate change.

In order to map forest cutting from one year to another, this script compares:
* the mean ndvi of the three previous months from the selected image
* to the mean ndvi of the three same months but from the previous year 

If the NDVI decreases above 0.25, it is certainly a clear cut.

As the aim of the script is to represent the forest cutting, it will color in red the pixel where cuts have been detected. 

The limitations are essentially:
* can't work if no unclouded pixel is available in the last three months 
* forest can be confused with crops (it is best to know it was forest previous year)
* cuts can be confused with later phenology (e.g. drought)

## Author of the script

Karasiak Nicolas

## Description of representative images

The two images are from Madagascar forest. The first one represent the forest in 2017 (raw image from S2 L2A). The second is from 2018 and the script highlights in red where forest clear cuttings have been made.

The third and the fourth images are the same things for Bouconne forest in France (near Toulouse).

![Forest Cut Temporal Detection script over Madagascar forest in 2017](fig/01_madagascar_rawS2.jpg)

![Forest Cut Temporal Detection script over Madagascar forest in 2018](fig/02_madagascar_result.jpg)

![Forest Cut Temporal Detection script over Bouconne forest in 2017](fig/03_bouconne_rawS2.jpg)

![Forest Cut Temporal Detection script over Bouconne forest in 2018](fig/04_bouconne_result.jpg)

More information is available in the [supplementary material](supplementary_material.pdf).

## Credits

Inspired by [Harel Dan temporal script](https://github.com/hareldunn/GIS_Repo/blob/master/Multi-Temporal%20NDVI%20for%20Sentinel%20Hub%20Custom%20Scripts){:target="_blank"}  
