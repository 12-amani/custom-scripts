# NDVI Anomaly Detection Script

<a href="#" id='togglescript'>Show</a> script or [download](ndvi_anomaly_detection_script.js){:target="_blank"} it.
<div id='script_view' style="display:none">
{% highlight javascript %}
      {% include_relative ndvi_anomaly_detection_script.js %}
{% endhighlight %}
</div>

## Evaluate and visualize
 - [Sentinel Playground temporal](https://apps.sentinel-hub.com/sentinel-playground-temporal/?source=S2&lat=51.20451728688966&lng=12.607498168945312&zoom=11&preset=CUSTOM&layers=B04,B03,B02&maxcc=30&gain=1.0&temporal=true&gamma=1.0&time=2015-01-01%7C2018-08-31&atmFilter=&showDates=false&evalscript=LyoKQXV0aG9yOiBKZWFuLUJhcHRpc3RlIFBsZXluZXQKKi8KCmNvbnN0IGNvbmZpZzIgPSB7CiAgZGVmYXVsdDogewogICAgbmJQYXN0WWVhcnM6IDMsCiAgICBkZWZhdWx0T3V0cHV0VmFsdWU6IC0yLAogICAgbmR2aU1pblZhbHVlOiAtMSwKICAgIGN1cnJlbnRJbmRleGVzTWluVmFsdWVzTnVtYmVyOiAxLAogICAgcGFzdEluZGV4ZXNNaW5WYWx1ZXNOdW1iZXI6IDMKICB9LAogIG5kdmlBbm9tYWx5OiB7CiAgICBwaXhlbEV2YWxNYXhWYWx1ZTogMC43CiAgfSwKICBsb3NzOiB7CiAgICBsb3dlclRyaWdnZXJQcmVtaXVtOiAwLAogICAgaGlnaGVyVHJpZ2dlclByZW1pdW06IDEsCiAgICBtaW5pbXVtQXZlcmFnZVZhbHVlUHJlbWl1bTogMC4xLAogICAgbWluaW11bVBheW91dFByZW1pdW06IDAKICB9Cn07CgpmdW5jdGlvbiBzZXR1cChkc3MpIHsKICAvLyBnZXQgYWxsIGJhbmRzIGZvciBkaXNwbGF5IGFuZCBhbmFseXNpcwogIHNldElucHV0Q29tcG9uZW50cyhbZHNzLkIwNCwgZHNzLkIwOF0pOyAvLyByZXR1cm4gYXMgUkdCCiAgc2V0T3V0cHV0Q29tcG9uZW50Q291bnQoMyk7Cn07Cgp2YXIgZmlsdGVyU2NlbmVzID0gZnVuY3Rpb24gZmlsdGVyU2NlbmVzKHNjZW5lcywgbWV0YWRhdGFJbnB1dCkgewogIGNvbnN0IG5iUGFzdFllYXJzID0gY29uZmlnMi5kZWZhdWx0Lm5iUGFzdFllYXJzOwogIHJldHVybiBzY2VuZXMuZmlsdGVyKGZ1bmN0aW9uIChzY2VuZSkgewogICAgcmV0dXJuIHNjZW5lLmRhdGUuZ2V0TW9udGgoKSA9PT0gbWV0YWRhdGFJbnB1dC50by5nZXRNb250aCgpICYmIHNjZW5lLmRhdGUuZ2V0RnVsbFllYXIoKSA%2BPSBtZXRhZGF0YUlucHV0LnRvLmdldEZ1bGxZZWFyKCkgLSBuYlBhc3RZZWFyczsKICB9KTsKfTsKCgpmdW5jdGlvbiBjYWxjdWxhdGVMb3NzKGN1cnJlbnRJbmRleEF2ZXJhZ2UsIHBhc3RJbmRleEF2ZXJhZ2UsIG1pbmltdW1BdmVyYWdlVmFsdWVQcmVtaXVtLCBsb3dlclRyaWdnZXJQcmVtaXVtLCBoaWdoZXJUcmlnZ2VyUHJlbWl1bSwgbWluaW11bVBheW91dFByZW1pdW0sIGRlZmF1bHRWYWx1ZSkgewogIGlmIChjdXJyZW50SW5kZXhBdmVyYWdlID09PSBudWxsIHx8IHBhc3RJbmRleEF2ZXJhZ2UgPT09IG51bGwpIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgaWYgKHBhc3RJbmRleEF2ZXJhZ2UgPCBtaW5pbXVtQXZlcmFnZVZhbHVlUHJlbWl1bSB8fCBwYXN0SW5kZXhBdmVyYWdlIDw9IGN1cnJlbnRJbmRleEF2ZXJhZ2UpIHJldHVybiAwOwogIHZhciBwZXJjZW50YWdlID0gKHBhc3RJbmRleEF2ZXJhZ2UgLSBjdXJyZW50SW5kZXhBdmVyYWdlKSAvIHBhc3RJbmRleEF2ZXJhZ2U7CiAgaWYgKHBlcmNlbnRhZ2UgPCBsb3dlclRyaWdnZXJQcmVtaXVtKSByZXR1cm4gMDsKICBpZiAocGVyY2VudGFnZSA%2BIGhpZ2hlclRyaWdnZXJQcmVtaXVtKSByZXR1cm4gMTsKICByZXR1cm4gTWF0aC5tYXgobWluaW11bVBheW91dFByZW1pdW0sIChwZXJjZW50YWdlIC0gKGxvd2VyVHJpZ2dlclByZW1pdW0gLSBtaW5pbXVtUGF5b3V0UHJlbWl1bSkpIC8gaGlnaGVyVHJpZ2dlclByZW1pdW0pOwp9OwoKdmFyIGNhbGN1bGF0ZU5kdmlBbm9tYWx5ID0gZnVuY3Rpb24gY2FsY3VsYXRlTmR2aUFub21hbHkoaW5kZXhlc0F2ZXJhZ2VzLCBwaXhlbEV2YWxNYXhWYWx1ZSwgZGVmYXVsdFZhbHVlKSB7CiAgaWYgKGluZGV4ZXNBdmVyYWdlcy5jdXJyZW50ID09PSBudWxsIHx8IGluZGV4ZXNBdmVyYWdlcy5wYXN0ID09PSBudWxsKSByZXR1cm4gZGVmYXVsdFZhbHVlOwogIHJldHVybiBNYXRoLm1heChNYXRoLm1pbihpbmRleGVzQXZlcmFnZXMuY3VycmVudCAtIGluZGV4ZXNBdmVyYWdlcy5wYXN0LCBwaXhlbEV2YWxNYXhWYWx1ZSksIDAgLSBwaXhlbEV2YWxNYXhWYWx1ZSk7Cn07Cgp2YXIgY2FsY3VsYXRlTkRWSSA9IGZ1bmN0aW9uIGNhbGN1bGF0ZU5EVkkoc2FtcGxlLCBjb25maWcpIHsKICB2YXIgZGVub20gPSBzYW1wbGUuQjA0ICsgc2FtcGxlLkIwODsKICBpZiAoZGVub20gPT09IDApIHJldHVybiBudWxsOwogIHZhciByZXN1bHQgPSAoc2FtcGxlLkIwOCAtIHNhbXBsZS5CMDQpIC8gZGVub207CiAgcmV0dXJuIHJlc3VsdCA%2BIGNvbmZpZy5uZHZpTWluVmFsdWUgPyByZXN1bHQgOiBudWxsOwp9OwoKY29uc3QgZXZhbHVhdGVQaXhlbCA9IGZ1bmN0aW9uIChzYW1wbGVzLCBzY2VuZXMpIHsKICB2YXIgaW5kZXhlc0F2ZXJhZ2VzID0gY2FsY3VsYXRlSW5kZXhBdmVyYWdlcyhzYW1wbGVzLCBzY2VuZXMsIGNvbmZpZzJbImRlZmF1bHQiXSwgY2FsY3VsYXRlTkRWSSk7CiAgcmV0dXJuIGNvbG9yQmxlbmQoY2FsY3VsYXRlTmR2aUFub21hbHkoaW5kZXhlc0F2ZXJhZ2VzLCBjb25maWcyLm5kdmlBbm9tYWx5LnBpeGVsRXZhbE1heFZhbHVlLCBjb25maWcyWyJkZWZhdWx0Il0uZGVmYXVsdE91dHB1dFZhbHVlKSwgW2NvbmZpZzJbImRlZmF1bHQiXS5kZWZhdWx0T3V0cHV0VmFsdWUsIDAgLSBjb25maWcyLm5kdmlBbm9tYWx5LnBpeGVsRXZhbE1heFZhbHVlLCAwLCBjb25maWcyLm5kdmlBbm9tYWx5LnBpeGVsRXZhbE1heFZhbHVlXSwgW1swLCAwLCAwXSwgWzEsIDAsIDBdLCBbMSwgMSwgMV0sIFswLCAxLCAwXV0pOwp9OwoKdmFyIGlzQ2xvdWRzID0gZnVuY3Rpb24gaXNDbG91ZHMoc2FtcGxlKSB7CiAgdmFyIG5nZHIgPSAoc2FtcGxlLkIwMyAtIHNhbXBsZS5CMDQpIC8gKHNhbXBsZS5CMDMgKyBzYW1wbGUuQjA0KTsKICB2YXIgcmF0aW8gPSAoc2FtcGxlLkIwMyAtIDAuMTc1KSAvICgwLjM5IC0gMC4xNzUpOwogIHJldHVybiBzYW1wbGUuQjExID4gMC4xICYmIChyYXRpbyA%2BIDEgfHwgcmF0aW8gPiAwICYmIG5nZHIgPiAwKTsKfTsKCnZhciBjYWxjdWxhdGVJbmRleGVzRm9yU2FtcGxlcyA9IGZ1bmN0aW9uIGNhbGN1bGF0ZUluZGV4ZXNGb3JTYW1wbGVzKHNhbXBsZXMsIHNjZW5lcywgY29uZmlnLCBwcm9jZXNzU2FtcGxlTWV0aG9kKSB7CiAgaWYgKHNhbXBsZXMubGVuZ3RoICE9PSBzY2VuZXMubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ3NhbXBsZXMgYW5kIHNjZW5lcyBhcnJheXMgZG8gbm90IGhhdmUgc2FtZSBsZW5ndGgnKTsKICByZXR1cm4gc2FtcGxlcy5yZWR1Y2UoZnVuY3Rpb24gKGFjYywgc2FtcGxlLCBpbmRleCkgewogICAgaWYgKGlzQ2xvdWRzKHNhbXBsZSkpIHJldHVybiBhY2M7CiAgICB2YXIgaW5kZXhWYWx1ZSA9IHByb2Nlc3NTYW1wbGVNZXRob2Qoc2FtcGxlLCBjb25maWcpOwogICAgaWYgKCFpbmRleFZhbHVlKSByZXR1cm4gYWNjOwogICAgdmFyIHNjZW5lWWVhciA9IHNjZW5lc1tpbmRleF0uZGF0ZS5nZXRGdWxsWWVhcigpOwoKICAgIGlmICghYWNjW3NjZW5lWWVhcl0pIHsKICAgICAgYWNjW3NjZW5lWWVhcl0gPSB7CiAgICAgICAgY291bnQ6IDAsCiAgICAgICAgc3VtOiAwCiAgICAgIH07CiAgICB9CgogICAgYWNjW3NjZW5lWWVhcl0uY291bnQrKzsKICAgIGFjY1tzY2VuZVllYXJdLnN1bSArPSBpbmRleFZhbHVlOwogICAgcmV0dXJuIGFjYzsKICB9LCB7fSk7Cn07Cgp2YXIgY2FsY3VsYXRlUGFzdEluZGV4ZXNBdmVyYWdlID0gZnVuY3Rpb24gY2FsY3VsYXRlUGFzdEluZGV4ZXNBdmVyYWdlKGluZGV4ZXMsIGN1cnJlbnRZZWFyLCBjb25maWcpIHsKICB2YXIgcGFzdEluZGV4ZXMgPSB7CiAgICBjb3VudDogMCwKICAgIHN1bTogMAogIH07CgogIGZvciAodmFyIGkgPSAxOyBpIDw9IGNvbmZpZy5uYlBhc3RZZWFyczsgaSsrKSB7CiAgICB2YXIgaW5kZXhWYWx1ZSA9IGluZGV4ZXNbY3VycmVudFllYXIgLSBpXTsKCiAgICBpZiAoaW5kZXhWYWx1ZSAmJiBpbmRleFZhbHVlLmNvdW50KSB7CiAgICAgIHBhc3RJbmRleGVzLmNvdW50Kys7CiAgICAgIHBhc3RJbmRleGVzLnN1bSArPSBpbmRleFZhbHVlLnN1bSAvIGluZGV4VmFsdWUuY291bnQ7CiAgICB9CiAgfQoKICByZXR1cm4gcGFzdEluZGV4ZXMuY291bnQgPj0gY29uZmlnLnBhc3RJbmRleGVzTWluVmFsdWVzTnVtYmVyID8gcGFzdEluZGV4ZXMuc3VtIC8gcGFzdEluZGV4ZXMuY291bnQgOiBudWxsOwp9OwoKZnVuY3Rpb24gY2FsY3VsYXRlSW5kZXhBdmVyYWdlcyhzYW1wbGVzLCBzY2VuZXMsIGNvbmZpZywgcHJvY2Vzc1NhbXBsZU1ldGhvZCkgewogIGlmICghc2NlbmVzLmxlbmd0aCkgdGhyb3cgbmV3IEVycm9yKCdzY2VuZXMgYXJyYXkgaXMgZW1wdHknKTsKICB2YXIgaW5kZXhlcyA9IGNhbGN1bGF0ZUluZGV4ZXNGb3JTYW1wbGVzKHNhbXBsZXMsIHNjZW5lcywgY29uZmlnLCBwcm9jZXNzU2FtcGxlTWV0aG9kKTsKICB2YXIgY3VycmVudFllYXIgPSBzY2VuZXNbMF0uZGF0ZS5nZXRGdWxsWWVhcigpOwogIHZhciBjdXJyZW50WWVhckluZGV4ID0gaW5kZXhlc1tjdXJyZW50WWVhcl07CiAgcmV0dXJuIHsKICAgIGN1cnJlbnQ6IGN1cnJlbnRZZWFySW5kZXggJiYgY3VycmVudFllYXJJbmRleC5jb3VudCA%2BPSBjb25maWcuY3VycmVudEluZGV4ZXNNaW5WYWx1ZXNOdW1iZXIgJiYgY3VycmVudFllYXJJbmRleC5zdW0gLyBjdXJyZW50WWVhckluZGV4LmNvdW50IHx8IG51bGwsCiAgICBwYXN0OiBjYWxjdWxhdGVQYXN0SW5kZXhlc0F2ZXJhZ2UoaW5kZXhlcywgY3VycmVudFllYXIsIGNvbmZpZykKICB9Owp9Owo%3D){:target="_blank"}    


## General description of the script

The goal of the script is to calculate the "anomaly" of an index, avoiding clouds.

In this example, we use the NDVI index, but this can be easily changed.
We define here the anomaly of an index as the difference between the average index value during the current month, and the average of the index value, in the same month, over a defined number of years in the past (3 in our script, defined in the "nbPastYears" parameter). It is slightly different from the usual definition. We have included a constraint on the number of scenes of past years to be used to average each pixel. At least one for the current year, and 3 for the past years. This is the "currentIndexesMinValuesNumber" and "pastIndexesMinValuesNumber" parameters. In order to keep only the NDVI value of days without clouds in the scene, we use the Braaten-Cohen-Yang cloud detector. We exclude from the computation the days where the cloud is detected by the algorithm (it gives "yes/no" based on a threshold).
This can lead to excluding some snowing part, but this is not an issue: we are not interested in the NDVI of snow, anyhow.

See the [supplementary material](supplementary_material.pdf) for more details.

## Author of the script

Jean-Baptiste Pleynet

## Description of representative images

The following GIF is the NDVI Anomaly generated by Sentinel Hub using the script. It shows the peak (August) and the end (October) of the drought of summer 2018 in Germany in the region South of Leipzig.

![NDVI Anomaly Detection script example](fig/leipzig_drought2018_ndvi.gif)

## References

![Braaten-Cohen-Yang cloud detector](https://github.com/sentinel-hub/custom-scripts/tree/master/sentinel-2/cby_cloud_detection){:target="_blank"}
    
