# Monthly Composite Script

## Evaluate and visualize
 - [Sentinel Playground temporal](https://apps.sentinel-hub.com/sentinel-playground-temporal/?source=S2&lat=44.61613347064405&lng=-0.7415771484375&zoom=11&preset=CUSTOM&layers=B04,B03,B02&maxcc=100&gain=1.0&temporal=true&gamma=1.0&time=2015-01-01%7C2019-03-29&atmFilter=ATMCOR&showDates=false&evalscript=LyoKU291cmNlOiBAbmthcmFzaWFrIC8gd3d3LmthcmFzaWFrLm5ldAoKTW9udGhseSBzeW50aGVzaXMsIHdpdGggYmVzdCBiYW5kcyByYXRpby4KVGlyZWQgb2Ygd2FpdGluZyB0aGUgcGVyZmVjdCBpbWFnZSB3aXRoIG5vIGNsb3VkIHRvIHNob3cgdGhlIHNub3cgY292ZXIgPyBUaGlzIG1vbnRobHkgc25vdyByZXBvcnQgaXMgZm9yIHlvdS4KVGhpcyBzY3JpcHQgd2lsbCBmaW5kIHdoZXJlIHRoZSBzbm93IGlzIHBlcnNpc3RlbnQgd2l0aGluIHRoZSBsYXN0IDMwIGRheXMgKGZyb20gY2hvc2VuIGRhdGUpLgpJbiBvcmRlciB0byB3ZWxsIHJlcHJlc2VudCB0aGUgbGFuZC1jb3ZlciwgdGhlIHNjcmlwdCB3aWxsIHN0b3JlIGVhY2ggcGVydGluZW50IGRhdGUgaW4gYSBsaXN0IGFuZCB3aWxsIHJlcHJlc2VudHMgdGhlIG1lZGlhbiB2YWx1ZS4KClRoaXMgc2VudGluZWwtMiBzY3JpcHQgdm9sdW50YXJpbHkgY29sb3IgaW4gZ3JlZW4gdGhlIGltYWdlIHRvIGJldHRlciBkaWZmZXJlbmlhdGUgdGhlIHNub3cgZnJvbSB0aGUgb3RoZXIgbGFuZC1jb3Zlci4KClNjcmlwdCByZXF1aXJlcyBtdWx0aS10ZW1wb3JhbCBwcm9jZXNzaW5nLgoqLwoKLy8gUHV0IDMgdG8gaGF2ZSBzeW50aGVzaXMgb2YgdGhlIGxhc3QgOTAgZGF5cwp2YXIgbnVtYmVyT2ZNb250aHNUb1VzZSA9IDE7Ci8vIFRocmVzb2xkIHRvIGNvbnNpZGVyIHBpeGVsIGFzIHNub3cKdmFyIE5EU0l0aHJlc29sZCA9IDAuMjsKLy8gSW4gb3JkZXIgdG8gZGlzbWlzcyBzbm93IGZyb20gd2F0ZXIKdmFyIHJlZFRocmVzb2xkID0gMC4yOwovLyBJbiBvcmRlciB0byBkaXNtaXNzIGNsb3Vkcwp2YXIgYmx1ZVRocmVzb2xkID0gMC4xMjsKdmFyIGhpZ2hCbHVlVGhyZXNvbGQgPSAwLjQ1OwoKdmFyIG51bWJlck9mVGltZXNGb3JXYXRlciA9IDI7IC8vIG1pbmltdW0gbnVtYmVyIG9mIHRpbWVzIHRvIGlkZW50aWZ5IGFzIHdhdGVyCgp2YXIgc3RyZXRjaE1pbiA9IDA7CnZhciBzdHJldGNoTWF4ID0gMTsKCmZ1bmN0aW9uIHNldHVwKGRzcykgewogICAgc2V0SW5wdXRDb21wb25lbnRzKFtkc3MuQjAyLCBkc3MuQjAzLCBkc3MuQjA0LCBkc3MuQjA1LCBkc3MuQjA4LCBkc3MuQjExXSk7CiAgICBzZXRPdXRwdXRDb21wb25lbnRDb3VudCgzKTsKfQoKZnVuY3Rpb24gTkRTSShzYW1wbGUpIHsKICAgIHJldHVybiAoKHNhbXBsZS5CMDMgLSBzYW1wbGUuQjExKSAvICgwLjAxICsgc2FtcGxlLkIwMyArIHNhbXBsZS5CMTEpKTsKfQoKZnVuY3Rpb24gTkRXSShzYW1wbGUpIHsKICByZXR1cm4gKChzYW1wbGUuQjAzIC0gc2FtcGxlLkIwOCkgLyAoc2FtcGxlLkIwMyArIHNhbXBsZS5CMDgpKTsKCn0KCmZ1bmN0aW9uIG1lZGlhbih2YWx1ZXMpIHsKICAgIC8vIGZyb20gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNDUzMDk0NDcvY2FsY3VsYXRpbmctbWVkaWFuLWphdmFzY3JpcHQKICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSByZXR1cm4gMDsKICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAxKSByZXR1cm4gdmFsdWVzWzBdOwoKICAgIHZhbHVlcy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICByZXR1cm4gYSAtIGI7CiAgICB9KTsKCiAgICB2YXIgaGFsZiA9IE1hdGguZmxvb3IodmFsdWVzLmxlbmd0aCAvIDIpOwogICAgcmV0dXJuIHZhbHVlc1toYWxmXTsKfQpmdW5jdGlvbiByKGEsYil7CiAgcmV0dXJuIChhL2IpOwp9CgpmdW5jdGlvbiBzdHJldGNoKHZhbCwgbWluLCBtYXgpIHsKICAgIHJldHVybiAodmFsIC0gbWluKSAvIChtYXggLSBtaW4pOwp9CgpmdW5jdGlvbiBpbmRleE9mTWF4UmF0aW8oYSxiKSB7CiAgcmF0aW9zID0gW107CiAgZm9yIChpID0gMDsgaSA8YS5sZW5ndGg7IGkrKykgewogICAgICByYXRpb3MucHVzaChyKGFbaV0sYltpXSkpOwogIH0KICAgIGlmIChyYXRpb3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQoKICAgIHZhciBtYXggPSByYXRpb3NbMF07CiAgICB2YXIgbWF4SW5kZXggPSAwOwoKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgcmF0aW9zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHJhdGlvc1tpXSA%2BIG1heCkgewogICAgICAgICAgICBtYXhJbmRleCA9IGk7CiAgICAgICAgICAgIG1heCA9IHJhdGlvc1tpXTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIG1heEluZGV4Owp9CgpmdW5jdGlvbiBldmFsdWF0ZVBpeGVsKHNhbXBsZXMsIHNjZW5lcykgewogICAgLy8gZm9yIHNub3cgc2NlbmUKICAgIGxldCBzbm93eUNvdW50ID0gMDsKICAgIGxldCBzbm93QjAyID0gW107CiAgICBsZXQgc25vd0IwMyA9IFtdOwogICAgbGV0IHNub3dCMDQgPSBbXTsKCiAgICAvLyBmb3IgdW5zbm93IHNjZW5lCiAgICBsZXQgQjAyID0gW107CiAgICBsZXQgQjAzID0gW107CiAgICBsZXQgQjA0ID0gW107CiAgICBsZXQgQjA1ID0gW107CiAgICBsZXQgQjA4ID0gW107CgogICAgLy8gZm9yIGhpZ2ggYmx1ZSBzY2VuZXMKICAgIGxldCBoaWdoQjAyID0gW107CiAgICBsZXQgaGlnaEIwMyA9IFtdOwogICAgbGV0IGhpZ2hCMDQgPSBbXTsKICAgIGxldCBoaWdoQjA1ID0gW107CiAgICBsZXQgaGlnaEIwOCA9IFtdOwoKICAgIC8vIGlzV2F0ZXIKICAgIGxldCBpc1dhdGVyID0gMDsKCiAgICAvLyB0byBtYW5hZ2UgaW1hZ2UgbGVuZ3RoIGJldHdlZW4gdGlsZXMKICAgIGxldCByZWFsU2FtcGxlTGVuZ3RoID0gMDsKCiAgICBmb3IgKGkgPSAwOyBpIDwgc2FtcGxlcy5sZW5ndGg7IGkrKykgewogICAgICAgIC8vIGluIG9yZGVyIHRvIGF2b2lkIGJsYWNrIHBpeGVsICh0aGUgb25lcyBiZXR3ZWVuIHRpbGVzKQogICAgICAgIGlmICggKHNhbXBsZXNbaV0uQjAyPjApICYgKHNhbXBsZXNbaV0uQjAzPjApICl7CiAgICAgICAgICByZWFsU2FtcGxlTGVuZ3RoKys7CiAgICAgICAgICBpZiAoIHNhbXBsZXNbaV0uQjAyPGJsdWVUaHJlc29sZCApIHsKICAgICAgICAgICAgQjAyLnB1c2goc2FtcGxlc1tpXS5CMDIpOwogICAgICAgICAgICBCMDMucHVzaChzYW1wbGVzW2ldLkIwMyk7CiAgICAgICAgICAgIEIwNC5wdXNoKHNhbXBsZXNbaV0uQjA0KTsKICAgICAgICAgICAgQjA1LnB1c2goc2FtcGxlc1tpXS5CMDUpOwogICAgICAgICAgICBCMDgucHVzaChzYW1wbGVzW2ldLkIwOCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCAoc2FtcGxlc1tpXS5CMDI8aGlnaEJsdWVUaHJlc29sZCkgJiAoc2FtcGxlc1tpXS5CMDI%2BYmx1ZVRocmVzb2xkKSApIHsKICAgICAgICAgIGhpZ2hCMDIucHVzaChzYW1wbGVzW2ldLkIwMik7CiAgICAgICAgICBoaWdoQjAzLnB1c2goc2FtcGxlc1tpXS5CMDMpOwogICAgICAgICAgaGlnaEIwNC5wdXNoKHNhbXBsZXNbaV0uQjA0KTsKICAgICAgICAgIGhpZ2hCMDUucHVzaChzYW1wbGVzW2ldLkIwNSk7CiAgICAgICAgICBoaWdoQjA4LnB1c2goc2FtcGxlc1tpXS5CMDgpOwogICAgICAgIH0KICAgICAgICBpZiAoKE5EU0koc2FtcGxlc1tpXSkgPiBORFNJdGhyZXNvbGQpICYgKHNhbXBsZXNbaV0uQjA0ID4gcmVkVGhyZXNvbGQpKSB7CiAgICAgICAgICAgIHNub3d5Q291bnQrKzsKICAgICAgICAgICAgc25vd0IwMi5wdXNoKHNhbXBsZXNbaV0uQjAyKTtzbm93QjAzLnB1c2goc2FtcGxlc1tpXS5CMDMpO3Nub3dCMDQucHVzaChzYW1wbGVzW2ldLkIwNCk7CiAgICAgICAgfQogICAgICAgIGlmICggKHNhbXBsZXNbaV0uQjAyPGJsdWVUaHJlc29sZCkgJiAgKE5EV0koc2FtcGxlc1tpXSkgPiAwKSApIHsKICAgICAgICAgIGlzV2F0ZXIrKzsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmICgoQjAyLmxlbmd0aD4wKSkgewogICAgICBpZiAoaXNXYXRlcj4yKXtiZXN0UmF0aW8gPSBpbmRleE9mTWF4UmF0aW8oQjAyLEIwOCk7fQogICAgICBlbHNle2Jlc3RSYXRpbyA9IGluZGV4T2ZNYXhSYXRpbyhCMDgsQjAzKTt9CiAgICAgIGNvbG9yTWFwID0gW3N0cmV0Y2goKDIuOCAqIEIwNFtiZXN0UmF0aW9dICsgMC4xICogQjA1W2Jlc3RSYXRpb10pLCBzdHJldGNoTWluLCBzdHJldGNoTWF4KSwgc3RyZXRjaCgoMi44ICogQjAzW2Jlc3RSYXRpb10gKyAwLjE1ICogQjA4W2Jlc3RSYXRpb10pLCBzdHJldGNoTWluLCBzdHJldGNoTWF4KSwgc3RyZXRjaCgoMi44ICogQjAyW2Jlc3RSYXRpb10pLCBzdHJldGNoTWluLCBzdHJldGNoTWF4KV07CiAgICB9CgogICAgZWxzZSBpZiAoKGhpZ2hCMDIubGVuZ3RoPjApICYgKEIwMi5sZW5ndGg8MSkpIHsKICAgICAgICBpZiAoaXNXYXRlcj4yKXtiZXN0UmF0aW8gPSBpbmRleE9mTWF4UmF0aW8oQjAyLEIwOCk7fQogICAgICAgIGVsc2V7YmVzdFJhdGlvID0gaW5kZXhPZk1heFJhdGlvKGhpZ2hCMDMsaGlnaEIwMik7fQogICAgICAgIGNvbG9yTWFwID0gW3N0cmV0Y2goKDIuOCAqIGhpZ2hCMDRbYmVzdFJhdGlvXSArIDAuMSAqIGhpZ2hCMDVbYmVzdFJhdGlvXSksIHN0cmV0Y2hNaW4sIHN0cmV0Y2hNYXgpLCBzdHJldGNoKCgyLjggKiBoaWdoQjAzW2Jlc3RSYXRpb10gKyAwLjE1ICogaGlnaEIwOFtiZXN0UmF0aW9dKSwgc3RyZXRjaE1pbiwgc3RyZXRjaE1heCksIHN0cmV0Y2goKDIuOCAqIGhpZ2hCMDJbYmVzdFJhdGlvXSksIHN0cmV0Y2hNaW4sIHN0cmV0Y2hNYXgpXTsKICAgIH0KICAgZWxzZSBpZiAoIChzbm93eUNvdW50ID4gMCkgJiAoaGlnaEIwMi5sZW5ndGg8MSkgJiAoQjAyLmxlbmd0aDwxKSApIHsKICAgICAgICAgIC8vIHNub3dDb2xvck1hcAogICAgICAgICAgY29sb3JNYXAgPSBbMS4xICogbWVkaWFuKHNub3dCMDQpLCAxLjMgKiBtZWRpYW4oc25vd0IwMyksIDEuMSAqIG1lZGlhbihzbm93QjAyKV07CiAgICAgICAgfQoKICAgIGVsc2UgewogICAgICAgICBjb2xvck1hcCA9IFsxLDAsMF07CiAgICAgfQoKICByZXR1cm4gY29sb3JNYXA7Cn0KCmZ1bmN0aW9uIGZpbHRlclNjZW5lcyhzY2VuZXMsIGlucHV0TWV0YWRhdGEpIHsKICAgIHJldHVybiBzY2VuZXMuZmlsdGVyKGZ1bmN0aW9uKHNjZW5lKSB7CiAgICAgICAgcmV0dXJuIHNjZW5lLmRhdGUuZ2V0VGltZSgpID49IChpbnB1dE1ldGFkYXRhLnRvLmdldFRpbWUoKSAtIChudW1iZXJPZk1vbnRoc1RvVXNlICogMzEgKiAyNCAqIDM2MDAgKiAxMDAwKSk7CiAgICB9KTsKfQo%3D){:target="_blank"}


## General description of the script

Monthly composite (31 days before the chosen date), computed with best bands ratio. This script is here for those who want a cloud free image representing the last 31 days.

In order to select the best pixel in a month (and avoid cloud), a selection is made using a ratio :
- When blue < 0.12, date is chosen where max ratio of B08 against B02.
- If no pixel available above, when blue < 0.45, date is chosen where max ratio of B03 against B02.
- If water is detected, date is chosen where max ratio of B02 against B08.
- If snow is detected, median of scene with snow.

## Author of the script

Karasiak Nicolas

## Description of representative images

Lac léman, composite from 2019-03-29

![Lac léman, composite from 2019-03-29](fig/lac_leman_2019-03-29.jpg)

South Madagascar, composite from 2019-04-26

![South Madagascar, composite from 2019-04-26](fig/south_madagascar_zoom1_2019-04-26.jpg)

![South Madagascar, composite from 2019-04-26](fig/south_madagascar_zoom2_2019-04-26.jpg)

![South Madagascar, composite from 2019-04-26](fig/south_madagascar_zoom3_2019-04-26.jpg)

See the [supplementary material](supplementary_material.pdf) for more examples.

## Credits

Thanks to :
- Pierre Markuse for his natural color script
- Harel Dan for his temporal script